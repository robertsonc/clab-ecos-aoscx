# ECOS Lab Topology (EC-V only, no vCX switches)
#
# This topology creates a 3-site SD-WAN lab with:
# - 3 EdgeConnect EC-V appliances (JFK, RDU, MIA)
# - 2 Linux nodes acting as ISP-A and ISP-B transport
# - 9 test clients (3 per site, connected directly to EC-V LAN interfaces)
#
# Site Layout:
#   JFK (New York, NY)   - JFK-ECV-01
#   RDU (Raleigh, NC)    - RDU-ECV-01
#   MIA (Miami, FL)      - MIA-ECV-01

name: jfk-rdu-mia_ec

mgmt:
  network: clab-mgmt
  ipv4-subnet: 172.30.30.0/24

topology:
  kinds:
    linux:
      image: ghcr.io/srl-labs/network-multitool

  nodes:
    #
    # === Transport Networks ===
    #
    isp-a:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      mgmt-ipv4: 172.30.30.14
      binds:
        - ../configs/jfk-rdu-mia-isp-a-dnsmasq.conf:/etc/dnsmasq.conf:ro
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 192.168.106.1/24 dev eth1
        - ip addr add 192.168.107.1/24 dev eth2
        - ip addr add 192.168.108.1/24 dev eth3
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth2 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth3 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth1 -j ACCEPT
        - iptables -A FORWARD -i eth2 -j ACCEPT
        - iptables -A FORWARD -i eth3 -j ACCEPT
        - apk add --no-cache dnsmasq
        - dnsmasq

    isp-b:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      mgmt-ipv4: 172.30.30.15
      binds:
        - ../configs/jfk-rdu-mia-isp-b-dnsmasq.conf:/etc/dnsmasq.conf:ro
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.100.6.1/24 dev eth1
        - ip addr add 10.100.7.1/24 dev eth2
        - ip addr add 10.100.8.1/24 dev eth3
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth2 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth3 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth1 -j ACCEPT
        - iptables -A FORWARD -i eth2 -j ACCEPT
        - iptables -A FORWARD -i eth3 -j ACCEPT
        - apk add --no-cache dnsmasq
        - dnsmasq
    #
    # === New York Site (JFK) ===
    #
    JFK-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.27
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: NewYork_NY
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    #
    # === Raleigh Site (RDU) ===
    #
    RDU-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.28
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: Raleigh_NC
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    #
    # === Miami Site (MIA) ===
    #
    MIA-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.29
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: Miami_FL
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    #
    # === Test Clients ===
    #
    JFK-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    JFK-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    JFK-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

    RDU-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    RDU-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    RDU-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

    MIA-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    MIA-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    MIA-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

  links:
    #
    # === WAN0 Links (EC-V wan0 <-> isp-a) ===
    #
    - endpoints: ["JFK-ECV-01:eth1", "isp-a:eth1"]
    - endpoints: ["RDU-ECV-01:eth1", "isp-a:eth2"]
    - endpoints: ["MIA-ECV-01:eth1", "isp-a:eth3"]

    #
    # === WAN1 Links (EC-V wan1 <-> isp-b) ===
    #
    - endpoints: ["JFK-ECV-01:eth3", "isp-b:eth1"]
    - endpoints: ["RDU-ECV-01:eth3", "isp-b:eth2"]
    - endpoints: ["MIA-ECV-01:eth3", "isp-b:eth3"]

    #
    # === Client Links (client:eth1 <-> EC-V LAN interfaces) ===
    #
    # New York clients
    - endpoints: ["JFK-client-managed:eth1", "JFK-ECV-01:eth2"]
    - endpoints: ["JFK-client-unmanaged:eth1", "JFK-ECV-01:eth4"]
    - endpoints: ["JFK-client-guest:eth1", "JFK-ECV-01:eth6"]

    # Raleigh clients
    - endpoints: ["RDU-client-managed:eth1", "RDU-ECV-01:eth2"]
    - endpoints: ["RDU-client-unmanaged:eth1", "RDU-ECV-01:eth4"]
    - endpoints: ["RDU-client-guest:eth1", "RDU-ECV-01:eth6"]

    # Miami clients
    - endpoints: ["MIA-client-managed:eth1", "MIA-ECV-01:eth2"]
    - endpoints: ["MIA-client-unmanaged:eth1", "MIA-ECV-01:eth4"]
    - endpoints: ["MIA-client-guest:eth1", "MIA-ECV-01:eth6"]
