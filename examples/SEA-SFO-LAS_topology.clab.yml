# ECOS + AOS-CX Lab Topology
#
# This topology creates a 3-site SD-WAN lab with:
# - 3 EdgeConnect EC-V appliances (SEA, SFO, LAS)
# - 3 AOS-CX switches (one per site)
# - 2 Linux nodes acting as ISP-A and ISP-B transport
#
# Site Layout:
#   SEA (Seattle, WA)        - SEA-ECV-01 + SEA-vCX-01
#   SFO (San Francisco, CA)  - SFO-ECV-01 + SFO-vCX-01
#   LAS (Las Vegas, NV)      - LAS-ECV-01 + LAS-vCX-01

name: sea-sfo-las_ec-cx

mgmt:
  network: clab-mgmt
  ipv4-subnet: 172.30.30.0/24

topology:
  kinds:
    linux:
      image: ghcr.io/srl-labs/network-multitool

  nodes:
    #
    # === Transport Networks ===
    #
    isp-a:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      mgmt-ipv4: 172.30.30.12
      binds:
        - ../configs/sea-sfo-las-isp-a-dnsmasq.conf:/etc/dnsmasq.conf:ro
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 192.168.103.1/24 dev eth1
        - ip addr add 192.168.104.1/24 dev eth2
        - ip addr add 192.168.105.1/24 dev eth3
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth2 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth3 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth1 -j ACCEPT
        - iptables -A FORWARD -i eth2 -j ACCEPT
        - iptables -A FORWARD -i eth3 -j ACCEPT
        - apk add --no-cache dnsmasq
        - dnsmasq

    isp-b:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      mgmt-ipv4: 172.30.30.13
      binds:
        - ../configs/sea-sfo-las-isp-b-dnsmasq.conf:/etc/dnsmasq.conf:ro
      exec:
        - sysctl -w net.ipv4.ip_forward=1
        - ip addr add 10.100.3.1/24 dev eth1
        - ip addr add 10.100.4.1/24 dev eth2
        - ip addr add 10.100.5.1/24 dev eth3
        - iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
        - iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth2 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth0 -o eth3 -m state --state RELATED,ESTABLISHED -j ACCEPT
        - iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth2 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth3 -o eth0 -j ACCEPT
        - iptables -A FORWARD -i eth1 -j ACCEPT
        - iptables -A FORWARD -i eth2 -j ACCEPT
        - iptables -A FORWARD -i eth3 -j ACCEPT
        - apk add --no-cache dnsmasq
        - dnsmasq
    #
    # === Seattle Site (SEA) ===
    #
    SEA-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.24
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: Seattle_WA
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    SEA-vCX-01:
      kind: vr-aoscx
      image: vrnetlab/aruba_arubaos-cx:20250822141147
      mgmt-ipv4: 172.30.30.34
      startup-config: ../configs/SEA-vCX-01.cfg
      env:
        AOSCX_ADMIN_PASSWORD: ${AOSCX_ADMIN_PASSWORD:-}

    #
    # === San Francisco Site (SFO) ===
    #
    SFO-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.25
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: SanFrancisco_CA
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    SFO-vCX-01:
      kind: vr-aoscx
      image: vrnetlab/aruba_arubaos-cx:20250822141147
      mgmt-ipv4: 172.30.30.35
      startup-config: ../configs/SFO-vCX-01.cfg
      env:
        AOSCX_ADMIN_PASSWORD: ${AOSCX_ADMIN_PASSWORD:-}

    #
    # === Las Vegas Site (LAS) ===
    #
    LAS-ECV-01:
      kind: generic_vm
      image: vrnetlab/aruba_ecos:9.6.1.0_106887
      mgmt-ipv4: 172.30.30.26
      env:
        ECOS_ADMIN_PASSWORD: ${ECOS_ADMIN_PASSWORD:-}
        ECOS_REGISTRATION_KEY: ${ECOS_REGISTRATION_KEY:-}
        ECOS_ACCOUNT_NAME: ${ECOS_ACCOUNT_NAME:-}
        ECOS_SITE_TAG: LasVegas_NV
        ECOS_PORTAL_HOSTNAME: ${ECOS_PORTAL_HOSTNAME:-}

    LAS-vCX-01:
      kind: vr-aoscx
      image: vrnetlab/aruba_arubaos-cx:20250822141147
      mgmt-ipv4: 172.30.30.36
      startup-config: ../configs/LAS-vCX-01.cfg
      env:
        AOSCX_ADMIN_PASSWORD: ${AOSCX_ADMIN_PASSWORD:-}

    #
    # === Test Clients ===
    #
    SEA-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    SEA-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    SEA-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

    SFO-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    SFO-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    SFO-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

    LAS-client-managed:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    LAS-client-unmanaged:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"
    LAS-client-guest:
      kind: linux
      image: ghcr.io/srl-labs/network-multitool
      exec:
        - sh -c "udhcpc -i eth1 && ip route del default dev eth0 && ping -i 5 8.8.8.8 > /dev/null 2>&1 &"

  links:
    #
    # === LAN Links (EC-V lan0 <-> AOS-CX 1/1/1) ===
    #
    # Seattle: SEA-ECV-01:lan0 (eth2) <-> SEA-vCX-01:1/1/1 (eth1)
    - endpoints: ["SEA-ECV-01:eth2", "SEA-vCX-01:eth1"]

    # San Francisco: SFO-ECV-01:lan0 (eth2) <-> SFO-vCX-01:1/1/1 (eth1)
    - endpoints: ["SFO-ECV-01:eth2", "SFO-vCX-01:eth1"]

    # Las Vegas: LAS-ECV-01:lan0 (eth2) <-> LAS-vCX-01:1/1/1 (eth1)
    - endpoints: ["LAS-ECV-01:eth2", "LAS-vCX-01:eth1"]

    #
    # === WAN0 Links (EC-V wan0 <-> isp-a) ===
    #
    - endpoints: ["SEA-ECV-01:eth1", "isp-a:eth1"]
    - endpoints: ["SFO-ECV-01:eth1", "isp-a:eth2"]
    - endpoints: ["LAS-ECV-01:eth1", "isp-a:eth3"]

    #
    # === WAN1 Links (EC-V wan1 <-> isp-b) ===
    #
    - endpoints: ["SEA-ECV-01:eth3", "isp-b:eth1"]
    - endpoints: ["SFO-ECV-01:eth3", "isp-b:eth2"]
    - endpoints: ["LAS-ECV-01:eth3", "isp-b:eth3"]

    #
    # === Client Links (client:eth1 <-> vCX access ports) ===
    #
    # Seattle clients
    - endpoints: ["SEA-client-managed:eth1", "SEA-vCX-01:eth2"]
    - endpoints: ["SEA-client-unmanaged:eth1", "SEA-vCX-01:eth3"]
    - endpoints: ["SEA-client-guest:eth1", "SEA-vCX-01:eth4"]

    # San Francisco clients
    - endpoints: ["SFO-client-managed:eth1", "SFO-vCX-01:eth2"]
    - endpoints: ["SFO-client-unmanaged:eth1", "SFO-vCX-01:eth3"]
    - endpoints: ["SFO-client-guest:eth1", "SFO-vCX-01:eth4"]

    # Las Vegas clients
    - endpoints: ["LAS-client-managed:eth1", "LAS-vCX-01:eth2"]
    - endpoints: ["LAS-client-unmanaged:eth1", "LAS-vCX-01:eth3"]
    - endpoints: ["LAS-client-guest:eth1", "LAS-vCX-01:eth4"]
