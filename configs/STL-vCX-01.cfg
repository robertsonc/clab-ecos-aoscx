!
! STL-vCX-01 - St. Louis AOS-CX Distribution Switch
! LAN: 10.2.0.0/16 block
!
hostname STL-vCX-01
!
vrf CSN_Managed
    rd 198.18.2.1:10010
    route-target export 65002:10010 evpn
    route-target import 65002:10010 evpn
vrf CSN_Unmanaged
    rd 198.18.2.1:10011
    route-target export 65002:10011 evpn
    route-target import 65002:10011 evpn
vrf CSN_Guest
    rd 198.18.2.1:10012
    route-target export 65002:10012 evpn
    route-target import 65002:10012 evpn
!
vlan 1010
    name CSN_Managed
vlan 1011
    name CSN_Unmanaged
vlan 1012
    name CSN_Guest
vlan 999
    name QUARANTINE
!
interface loopback 0
    ip address 198.18.2.1/32
!
router ospf 1
   passive-interface default
   redistribute connected
   redistribute local loopback
   area 0.0.0.0
interface 1/1/1
    no shutdown
    description STL-ECV-01 lan0
    ip address 10.2.0.1/30
    ip ospf 1 area 0.0.0.0
    no ip ospf passive
!
ip route 0.0.0.0/0 10.2.0.2 tag 999
!
router bgp 65002
    bgp router-id 198.18.2.1
    neighbor 198.19.0.2 remote-as 64002
    neighbor 198.19.0.2 update-source loopback 0
    neighbor 198.19.0.2 ebgp-multihop 2
    address-family ipv4 unicast
        neighbor 198.19.0.2 activate
    exit-address-family
    address-family l2vpn evpn
        neighbor 198.19.0.2 send-community both
        neighbor 198.19.0.2 activate
    exit-address-family
!
    vrf CSN_Managed
        address-family ipv4 unicast
            redistribute connected
            redistribute local loopback
        exit-address-family
        address-family ipv6 unicast
            redistribute connected
        exit-address-family
!
    vrf CSN_Unmanaged
        address-family ipv4 unicast
            redistribute connected
            redistribute local loopback
        exit-address-family
        address-family ipv6 unicast
            redistribute connected
        exit-address-family
!
    vrf CSN_Guest
        address-family ipv4 unicast
            redistribute connected
            redistribute local loopback
        exit-address-family
        address-family ipv6 unicast
            redistribute connected
        exit-address-family
!
evpn
    arp-suppression
    vlan 1010
        rd auto
        route-target export auto
        route-target import auto
        redistribute host-route
    vlan 1011
        rd auto
        route-target export auto
        route-target import auto
        redistribute host-route
    vlan 1012
        rd auto
        route-target export auto
        route-target import auto
        redistribute host-route
!
interface vlan 1010
    vrf attach CSN_Managed
    ip mtu 9198
    ip address 192.168.20.1/24
interface vlan 1011
    vrf attach CSN_Unmanaged
    ip mtu 9198
    ip address 192.168.21.1/24
interface vlan 1012
    vrf attach CSN_Guest
    ip mtu 9198
    ip address 192.168.22.1/24
interface vlan 999
    ip address 192.168.92.1/24
interface vxlan 1
    source ip 198.18.2.1
    no shutdown
    vni 1010
        vlan 1010
    vni 1011
        vlan 1011
    vni 1012
        vlan 1012
    vni 10010
        vrf CSN_Managed
        routing
    vni 10011
        vrf CSN_Unmanaged
        routing
    vni 10012
        vrf CSN_Guest
        routing
!
radius-server retries 3
radius-server host 10.127.3.110 key ciphertext AQBapWjoVfGPw3yI/2XhjWm1tJ76ybLKq3JT4ZLGRpFse87JCQAAAL/7AGp2/BrLKQ==
aaa authentication allow-fail-through
!
!
aaa group server radius SASE-DEMO
    server 10.127.3.110
!
port-access role QUARANTINE
    vlan access 999
port-access role MANAGED
    vlan access 1010
port-access role UNMANAGED
    vlan access 1011
port-access role GUEST
    vlan access 1012
!
aaa authentication port-access mac-auth
    radius server-group SASE-DEMO
    enable
!
interface 1/1/2
    no shutdown
    description CSN_Managed client access
    no routing
    vlan access 999
    aaa authentication port-access preauth-role QUARANTINE
    aaa authentication port-access reject-role QUARANTINE
    aaa authentication port-access critical-role QUARANTINE
    aaa authentication port-access client-limit 3
    aaa authentication port-access mac-auth
    enable
interface 1/1/3
    no shutdown
    description CSN_Unmanaged client access
    no routing
    vlan access 999
    aaa authentication port-access preauth-role QUARANTINE
    aaa authentication port-access reject-role QUARANTINE
    aaa authentication port-access critical-role QUARANTINE
    aaa authentication port-access client-limit 3
    aaa authentication port-access mac-auth
    enable
interface 1/1/4
    no shutdown
    description CSN_Guest client access
    no routing
    vlan access 999
    aaa authentication port-access preauth-role QUARANTINE
    aaa authentication port-access reject-role QUARANTINE
    aaa authentication port-access critical-role QUARANTINE
    aaa authentication port-access client-limit 3
    aaa authentication port-access mac-auth
    enable
!
dhcp-server vrf CSN_Managed
    pool CSN_Managed
        range 192.168.20.11 192.168.20.25
        default-router 192.168.20.1
        dns-server 8.8.8.8 8.8.4.4
        lease 00:12:00
        enable
        exit
    enable
    exit
dhcp-server vrf CSN_Unmanaged
    pool CSN_Unmanaged
        range 192.168.21.11 192.168.21.25
        default-router 192.168.21.1
        dns-server 8.8.8.8 8.8.4.4
        lease 00:12:00
        enable
        exit
    enable
    exit
dhcp-server vrf CSN_Guest
    pool CSN_Guest
        range 192.168.22.11 192.168.22.25
        default-router 192.168.22.1
        dns-server 8.8.8.8 8.8.4.4
        lease 00:12:00
        enable
        exit
    enable
    exit
dhcp-server vrf default
    pool QUARANTINE
        range 192.168.92.11 192.168.92.25
        default-router 192.168.92.1
        dns-server 8.8.8.8 1.1.1.1
        exit
    enable
    exit
!
